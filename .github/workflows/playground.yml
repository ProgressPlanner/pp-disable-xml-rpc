name: Playground Comment

on:
  pull_request:

jobs:
  playground:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read

    steps:
      - uses: actions/checkout@v4

      # Put plugin files into a folder named exactly like the repo
      - name: Stage plugin in <repo> folder
        run: |
          set -euxo pipefail
          REPO="${{ github.event.repository.name }}"
          rm -rf "$REPO"
          mkdir "$REPO"
          rsync -a \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            ./ "$REPO/"

      # Create a zip that *includes* the top-level folder
      - name: Make repo-named zip that preserves folder
        run: |
          set -euxo pipefail
          REPO="${{ github.event.repository.name }}"
          zip -r "${REPO}.zip" "$REPO"

      # Upload that zip as the artifact
      - name: Upload plugin zip
        uses: actions/upload-artifact@v4
        with:
          name: plugin
          path: ${{ github.event.repository.name }}.zip

      # Comment with Playground link pointing at the artifact
      - uses: mshick/add-pr-comment@v2
        with:
          message: |
            **Test on Playground**
            [Test this pull request on the Playground](https://playground.wordpress.net/#{"landingPage":"/wp-admin/","features":{"networking":true},"steps":[{"step":"defineWpConfigConsts","consts":{"IS_PLAYGROUND_PREVIEW":true}},{"step":"login","username":"admin","password":"password"},{"step":"installPlugin","pluginZipFile":{"res]()_)
